pico-8 cartridge // http://www.pico-8.com
version 27
__lua__
function _init()
 cls()
 t=0
 boundary = {
 x1 = 0, y1 = 0,
 x2 = 120, y2 = 120,
 }
 player = {
  x=60,
  y=60,
  dx=0,
  dy=0,
  sp=6,
  sw=2,
  sh=2,
  box = {x1=4, y1=3, x2=13, y2=16},
  boundary = {
  x1=0,
  y1=0,
  x2=120,
  y2=120
  }
 }
 template = {
  ghost = {
   sp = 2,
   box = {x1=0, y1=0, x2=8, y2=8},
   dr = 50,
   dx = -1,
   dy = 0,
   csfx = 0,
  },
  witch = {
   name = "witch",
   sp = 3,
   sw = 2,
   sh = 2,
   box = {x1=0, y1=0, x2=16, y2=16},
   dr = 90,
   dx = -1,
   dy = 0,
   csfx = 1,
  }
 }
 monsters = {}
end

function did_collide(a,b)
 if (a.x + a.box.x1 > b.x + b.box.x2 or
     a.y + a.box.y1 > b.y + b.box.y2 or
     b.x + b.box.x1 > a.x + a.box.x2 or
     b.y + b.box.y1 > a.y + a.box.y2) then
  return false
 else
  return true
 end
end

function collide_any(obj, objects)
 local collisions = {}
 for o in all(objects) do
  if (did_collide(obj, o)) then add(collisions, o) end
 end
 return collisions
end

function maybe_spawn(template, extra)
 if ((t % template.dr) == 0) then
  e = spawn(template, extra)
  --  printh("drawing thing at " .. dump(e))
  add(monsters, e)
 end
end

function _update()
 t += 1
 maybe_spawn(template.ghost, {x=(rndi(80) + 20), y=(rndi(100) + 10), dx=(-rnd(2))})
 maybe_spawn(template.witch, {x=110, y=(rndi(100) + 10)})
 for monster in all(monsters) do
  move_sprite(monster)
  if (monster.x < boundary.x1 or monster.x > boundary.x2 or
      monster.y < boundary.y1 or monster.y > boundary.y2) then
    -- printh("monster out of bounds: " .. dump(monster))
    del(monsters, monster)
  end
 end
 local new_collisions = collide_any(player, monsters)
 if next(new_collisions) == nil then
  -- no collisions, no problem
 else
  for collision in all(new_collisions) do
   sfx(collision.csfx)
   del(monsters, collision)
  end
 end
 controls()
end

function spawn(template, extra)
 local e = copy(template)
 -- printh("merging " .. dump(extra) .. " into " .. dump(e))
 merge(e, extra)
 return e
end

function controls()
 if btn(⬆️) and player.y > player.boundary.y1 then
  player.y = player.y - 1
 end
 if btn(⬇️) and player.y < player.boundary.y2 then
  player.y = player.y + 1
 end
 if btn(⬅️) and player.x > player.boundary.x1 then
  player.x = player.x - 1
 end
 if btn(➡️) and player.x < player.boundary.x2 then
  player.x = player.x + 1
 end
end


function _draw()
 cls()
 draw_sprite(player)
 for monster in all(monsters) do
  draw_sprite(monster)
 end
end

function move_sprite(s)
 if (s.name == "witch") then
  s.ddy = (rnd(0.5) - 0.25)
  s.ddx = (rnd(0.5) - 0.25)
 end
 s.dx = s.dx + (s.ddx or 0)
 s.dy = s.dy + (s.ddy or 0)
 s.x = s.x + s.dx
 s.y = s.y + s.dy
end

function draw_sprite(s)
 w = s.sw or 1
 h = s.sh or 1
 spr(s.sp, s.x, s.y, w, h)
end

function rndi(n)
 return flr(rnd(n))
end

function copy(a)
 local n = {}
 for k,v in pairs(a) do n[k] = v end
 return n
end

function merge(a,b)
 for k,v in pairs(b) do a[k] = v end
end

function dump(tbl)
 s = ""
 for k,v in pairs(tbl) do
  s = s .. k .. "=" .. v .. ","
 end
 return s
end


__gfx__
00000000000000005677765000000000550055000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000006777776500000055555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700099009907707077600000055555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700009900990777777760000000055500000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000
00077000000aa0007777777640006666660500000000000000000bb000bb00000000000000000000000000000000000000000000000000000000000000000000
00700700000aa0006700076504666066660000000000000000000b00000b00000000000000000000000000000000000000000000000000000000000000000000
0000000008888880567776500004446660000000000000000000b0008080b0000000000000000000000000000000000000000000000000000000000000000000
0000000008888880056665000000666600000000000000000000b0000000b0000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000600644000004000000000000b0880080b0000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000006066044444440000000000000b08888b00000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000006606004455440000000000000bb000bb00000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000060060445454000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000060454450000000000000bbbbbbbbb0000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000400400000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000440000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000040000000000000000000b0b0000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000010000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
00030000000000000002050060500b0500f05014050170501e050280502e050320503405035050330502f0502b0501d0501c0501c0501c0501e0502005024050260501a050160502005022050300501c05025050
000300003d0503d0503b0503a0503805037050360503605037050380503a0503c0503d0503d050290502b0502d0502f0503105031050310502f0502b05023050200501d0501c0502e0503305037050370503f050
000300001f7501f7501f7501e7501e7501d7501d7501d7501d750257502575025750257502575025750257501f750267502675027750277502875023750247502575025750257502575026750267502675026750
